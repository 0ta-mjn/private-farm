# 農業日誌機能設計

## 基本要件

農業日誌機能は、日々の農作業を記録し、効果的な作業管理と振り返りを可能にする機能です。センサーデータとの連携により、作業と環境データの関連性を可視化し、データドリブンな農業経営をサポートします。

### 機能概要

#### 1. 日誌入力機能

- **基本情報入力**
  - 日付選択（カレンダーUI）
  - 作業内容（テキストエリア、最大2000文字）
  - 対象ほ場の選択（Thing との紐付け）
  - 作業時間の記録（開始時刻・終了時刻）
  - 天候情報（晴れ/曇り/雨/雪）

- **分類・タグ機能**
  - 作業種別（プリセット + カスタム）
    - 播種・定植
    - 除草・間引き
    - 施肥・堆肥散布
    - 灌水・水管理
    - 病害虫防除
    - 収穫
    - 土づくり・耕起
    - その他
  - カスタムタグ（自由入力、#タグ形式）
  - 対象作物の選択

- **写真添付機能**
  - 最大5枚の写真添付
  - ドラッグ&ドロップ対応
  - 写真プレビュー機能
  - 写真の説明文入力（各写真につき100文字まで）
  - 写真の削除・並び替え機能

#### 2. 日誌表示・管理機能

- **一覧表示**
  - カード形式での日誌一覧
  - 日付順（新しい順/古い順）での表示
  - ページネーション（20件/ページ）
  - 写真サムネイル表示
  - 作業種別・タグのラベル表示

- **詳細表示**
  - 日誌の全情報表示
  - 写真のライトボックス表示
  - 関連センサーデータの表示
  - 編集・削除機能へのアクセス

- **編集・削除機能**
  - 作成者のみ編集・削除可能
  - 編集履歴の記録
  - 削除時の確認ダイアログ
  - 論理削除による復元可能性

#### 3. 検索・フィルタリング機能

- **検索機能**
  - 全文検索（作業内容、タグ、写真説明文）
  - 日付範囲での検索
  - キーワード検索のハイライト表示

- **フィルタリング機能**
  - 作業種別でのフィルタ
  - 対象ほ場でのフィルタ
  - タグでのフィルタ
  - 天候でのフィルタ
  - 複数条件での組み合わせフィルタ

- **並び替え機能**
  - 日付順（昇順/降順）
  - 作成日時順
  - 更新日時順

#### 4. センサーデータ連携機能

- **自動データ取得**
  - 日誌作成時に該当日のセンサーデータを自動取得
  - 対象ほ場のセンサー情報を優先表示
  - データ取得期間：作業日の前後3日間

- **データ表示**
  - 気象データ（気温、湿度、降水量、風速、日射量）
  - 土壌データ（含水率、温度、EC）
  - 簡易グラフ表示（折れ線グラフ）
  - データの数値表示（平均値、最大値、最小値）

## UI/UX設計

### 画面構成

#### 1. 日誌一覧画面 (`/diary`)

- **ヘッダー**
  - ページタイトル「農業日誌」
  - 「新しい日誌を作成」ボタン（プライマリボタン）
  - 検索バー
  - フィルタボタン

- **フィルタエリア** (折りたたみ可能)
  - 日付範囲選択（DateRangePicker）
  - 作業種別選択（複数選択可能）
  - 対象ほ場選択（複数選択可能）
  - タグ選択（複数選択可能）
  - 天候選択（複数選択可能）
  - フィルタクリアボタン
  - 適用ボタン

- **日誌リスト**
  - カード形式での表示
  - 各カードの構成：
    - 作業日・天候アイコン
    - 写真サムネイル（最大3枚表示）
    - 作業種別ラベル
    - 作業内容（150文字まで + 省略記号）
    - 対象ほ場情報
    - カスタムタグ
    - 作成日時・編集日時

- **ページネーション**
  - 20件/ページ
  - ページ番号表示
  - 前/次ページボタン

#### 2. 日誌詳細ダイアログ (`/diary?diaryId=[id]`)

- **ダイアログ仕様**
  - shadcn/ui Dialog コンポーネント使用
  - URL クエリパラメータ (`?diaryId=xxx`) でダイアログ制御
  - ブラウザ履歴対応（戻るボタンでダイアログ閉じる）
  - ESCキー・背景クリックでダイアログ閉じる
  - レスポンシブ対応（モバイルでは全画面表示）

- **ダイアログヘッダー**
  - 日誌タイトル（作業日 + 作業種別）
  - 閉じるボタン（X）
  - 編集ボタン（作成者のみ）
  - 削除ボタン（作成者のみ）
  - 共有ボタン（将来機能）

- **ダイアログ本文**
  - **基本情報セクション**
    - 作業日・天候アイコン
    - 作業時間（開始〜終了）
    - 作業種別ラベル・カスタムタグ
    - 対象ほ場情報

  - **作業内容セクション**
    - 作業内容（全文表示、改行対応）
    - 文字数表示

  - **写真ギャラリーセクション** (写真がある場合のみ)
    - 写真グリッド表示（最大5枚）
    - 写真クリックで別のライトボックス表示
    - 写真説明文の表示

  - **センサーデータセクション** (データがある場合のみ)
    - 折りたたみ可能なアコーディオン
    - データ取得期間表示
    - 簡易グラフ表示（Chart.js使用）
    - データテーブル表示切り替えタブ

  - **編集履歴セクション** (編集履歴がある場合のみ)
    - 折りたたみ可能なアコーディオン
    - 編集日時・編集者・変更内容のサマリー

- **ダイアログフッター**
  - 作成日時・更新日時の表示
  - アクションボタン（編集・削除・閉じる）

#### 3. 日誌作成/編集ダイアログ (`/diary?action=new`, `/diary?action=edit&diaryId=[id]`)

- **ダイアログ仕様**
  - shadcn/ui Dialog コンポーネント使用
  - URL クエリパラメータでダイアログ制御
    - 作成: `?action=new`
    - 編集: `?action=edit&diaryId=xxx`
  - フォームの未保存状態での離脱確認
  - 大画面サイズのダイアログ（max-width: 4xl）

- **フォーム構成**
  - 作業日選択（必須、DatePicker）
  - 対象ほ場選択（必須、複数選択可能、Multi-Select）
  - 作業種別選択（必須、Select）
  - 作業時間入力（任意、TimePicker）
  - 天候選択（任意、Radio Group）
  - 作業内容入力（必須、2000文字以内、Textarea）
  - カスタムタグ入力（任意、Tag Input）
  - 写真アップロード（任意、最大5枚、Drag & Drop）

- **バリデーション**
  - リアルタイムバリデーション（react-hook-form + zod）
  - 文字数カウンター表示
  - エラーメッセージの表示
  - 必須フィールドのマーク表示

- **操作ボタン**
  - 保存ボタン（プライマリ、Submit）
  - 下書き保存ボタン（セカンダリ、将来機能）
  - キャンセルボタン（ダイアログ閉じる）
  - プレビューボタン（別タブで詳細ダイアログ開く、将来機能）

### URL設計とルーティング

#### 1. SSG対応URL構造

```
/diary                          # 日誌一覧ページ（SSG）
  ├─ ?diaryId=xxx              # 詳細ダイアログ表示
  ├─ ?action=new               # 新規作成ダイアログ表示
  ├─ ?action=edit&diaryId=xxx  # 編集ダイアログ表示
  └─ ?search=keyword&...       # 検索・フィルタ結果
```

#### 2. shallow routing の活用

- **ダイアログ開閉**: shallow routing でページリロードなし
- **ブラウザ履歴**: 戻るボタンでダイアログ閉じる
- **SEO対応**: ダイアログ状態はインデックス対象外
- **パフォーマンス**: ページデータの再取得なし

### レスポンシブデザイン

#### デスクトップ (1024px以上)

- 3カラムレイアウト（サイドバー + メインコンテンツ + サブ情報）
- 日誌一覧: 2カラムのカードグリッド
- フィルタエリア: サイドバー固定表示
- **ダイアログ**: 中央表示（max-width: 4xl）

#### タブレット (768px - 1023px)

- 2カラムレイアウト（サイドバー + メインコンテンツ）
- 日誌一覧: 1カラムのカードリスト
- フィルタエリア: 折りたたみ式
- **ダイアログ**: 中央表示（max-width: 3xl）

#### モバイル (767px以下)

- 1カラムレイアウト
- 日誌一覧: 縦積みカードリスト
- フィルタエリア: モーダル表示
- 写真: スワイプ対応ギャラリー
- **ダイアログ**: 全画面表示（height: 100vh）

## 技術仕様

### API設計

#### 1. tRPC エンドポイント

```typescript
// diary ルーター
export const diaryRouter = createTRPCRouter({
  // 日誌一覧取得
  list: authenticatedProcedure
    .input(DiaryListInputSchema)
    .query(async ({ input, ctx }) => { /* 実装 */ }),

  // 日誌詳細取得
  detail: authenticatedProcedure
    .input(z.object({ id: z.string() }))
    .query(async ({ input, ctx }) => { /* 実装 */ }),

  // 日誌作成
  create: authenticatedProcedure
    .input(DiaryCreateInputSchema)
    .mutation(async ({ input, ctx }) => { /* 実装 */ }),

  // 日誌更新
  update: authenticatedProcedure
    .input(DiaryUpdateInputSchema)
    .mutation(async ({ input, ctx }) => { /* 実装 */ }),

  // 日誌削除
  delete: authenticatedProcedure
    .input(z.object({ id: z.string() }))
    .mutation(async ({ input, ctx }) => { /* 実装 */ }),

  // センサーデータ取得
  getSensorData: authenticatedProcedure
    .input(z.object({ 
      diaryId: z.string(),
      thingIds: z.array(z.string())
    }))
    .query(async ({ input, ctx }) => { /* 実装 */ }),
});
```

#### 2. 入力スキーマ定義

```typescript
// 日誌一覧取得パラメータ
export const DiaryListInputSchema = z.object({
  organizationId: z.string(),
  page: z.number().min(1).default(1),
  limit: z.number().min(1).max(100).default(20),
  search: z.string().optional(),
  dateFrom: z.date().optional(),
  dateTo: z.date().optional(),
  workTypes: z.array(z.string()).optional(),
  thingIds: z.array(z.string()).optional(),
  workerIds: z.array(z.string()).optional(),
  tags: z.array(z.string()).optional(),
  weather: z.array(z.string()).optional(),
  sortBy: z.enum(['work_date', 'created_at', 'updated_at']).default('work_date'),
  sortOrder: z.enum(['asc', 'desc']).default('desc'),
});

// 日誌作成パラメータ
export const DiaryCreateInputSchema = z.object({
  organizationId: z.string(),
  workDate: z.date(),
  content: z.string().min(1).max(2000),
  workType: z.string(),
  startTime: z.string().optional(),
  endTime: z.string().optional(),
  weather: z.string().optional(),
  customTags: z.array(z.string()).optional(),
  thingIds: z.array(z.string()).min(1),
  workerIds: z.array(z.string()).min(1),
  photos: z.array(DiaryPhotoInputSchema).max(5).optional(),
});

// 写真アップロードスキーマ
export const DiaryPhotoInputSchema = z.object({
  file: z.instanceof(File),
  description: z.string().max(100).optional(),
  orderIndex: z.number(),
});
```

### パフォーマンス最適化

#### 1. データ取得最適化

- **ページネーション**: 20件/ページの分割読み込み
- **遅延読み込み**: 写真のlazy loading
- **キャッシュ戦略**: TanStack Query による自動キャッシュ
- **データベースインデックス**:
  - 全文検索用インデックス（content, custom_tags）

#### 2. リアルタイム更新

- **Supabase Realtime**: 日誌の追加・更新通知
- **楽観的更新**: 即座なUI更新 + バックグラウンド同期
- **コンフリクト解決**: 編集競合時の適切なハンドリング

## セキュリティ・権限管理

### アクセス制御

#### 1. 組織レベル制御

- **読み取り権限**: 組織メンバー全員
- **作成権限**: 組織メンバー全員
- **編集権限**: 作成者のみ
- **削除権限**: 作成者 または 組織管理者

#### 2. データ分離

- **RLS (Row Level Security)**: Supabase RLS による組織データ分離
- **API レベル検証**: 全てのエンドポイントで組織所属確認
- **セッション管理**: Supabase Auth による認証状態管理

### データ保護

#### 1. 入力検証

- **フロントエンド**: Zod スキーマによるクライアントサイド検証
- **バックエンド**: tRPC input validation による二重検証
- **SQL インジェクション対策**: Prisma ORM による自動エスケープ
- **XSS 対策**: Next.js の自動エスケープ + CSP ヘッダー

#### 2. ファイルアップロード保護

- **ファイル形式検証**: MIME タイプチェック + 拡張子検証
- **ファイルサイズ制限**: クライアント・サーバー両側での制限
- **ウイルススキャン**: 将来的な導入検討
- **アップロード先制限**: 組織別ディレクトリ分離

## テスト戦略

### 単体テスト

#### 1. コンポーネントテスト

- **日誌一覧コンポーネント**: 表示・フィルタリング・ページネーション
- **日誌詳細コンポーネント**: 詳細表示・編集ボタン・センサーデータ連携
- **日誌作成/編集フォーム**: バリデーション・写真アップロード・送信処理
- **写真ギャラリー**: ライトボックス・スワイプ・削除機能

#### 2. API テスト

- **tRPC エンドポイント**: 各操作の正常系・異常系テスト
- **認証・認可**: 権限チェックの動作確認
- **バリデーション**: 入力検証の動作確認
- **ファイルアップロード**: アップロード処理・エラーハンドリング

### 統合テスト

#### 1. ユーザーフロー

- **日誌作成フロー**: 作成 → 保存 → 詳細表示 → 編集 → 削除
- **検索・フィルタリング**: 条件指定 → 結果表示 → ソート変更
- **写真管理**: アップロード → プレビュー → 保存 → ライトボックス表示
- **センサーデータ連携**: 日誌作成時の自動取得 → 詳細画面での表示

#### 2. レスポンシブテスト

- **デスクトップ**: 全機能の動作確認
- **タブレット**: レイアウト・操作性の確認
- **モバイル**: タッチ操作・スワイプ・モーダル表示の確認

### E2E テスト

#### 1. ブラウザテスト

- **複数ブラウザ**: Chrome, Firefox, Safari での動作確認
- **ユーザーシナリオ**: 実際の農作業記録フローの再現
- **パフォーマンステスト**: 大量データでの動作確認
- **アクセシビリティテスト**: キーボード操作・スクリーンリーダー対応

#### 2. エラーシナリオ

- **ネットワークエラー**: オフライン・低速回線での動作
- **サーバーエラー**: 500エラー・タイムアウト時の処理
- **権限エラー**: 不正アクセス・セッション切れ時の処理
