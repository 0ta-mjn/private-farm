# サイドバー設計

## フェーズ1: 農業日誌・ユーザー管理機能

### 基本要件

フェーズ1では、農業日誌機能とユーザー管理機能に必要な最低限のサイドバー機能を実装する。将来のフェーズで追加される機能への拡張性も考慮した設計とする。

### 機能要件

#### 1. メインナビゲーション

- **ホーム**
  - ダッシュボードホームへのリンク
  - アクティブ状態の視覚的表示

- **農業日誌**
  - 日誌一覧ページへのリンク
  - アクティブ状態の視覚的表示
  - サブアクション: 「新しい日誌を作成」ボタン

#### 2. ユーザー・組織情報表示

- **ユーザープロフィール**
  - ユーザー名の表示
  - プロフィール設定へのリンク
  - アバター画像（将来対応）

- **組織セレクター** 🆕
  - shadcn/ui Selectコンポーネントによるドロップダウンメニュー
  - 現在選択中の組織名とアイコンの表示
  - 各組織での役職表示（管理者/メンバー）
  - 組織の自動切り替え機能（onValueChange）
  - ローカルストレージでの選択状態永続化
  - 未選択時の「組織を選択」プレースホルダー
  - サイドバーヘッダーに配置

- **組織設定**
  - 組織設定へのリンク
  - 設定セクション内に配置
  - 組織管理機能への拡張性を考慮

#### 3. 設定・管理機能

- **設定メニュー**
  - 組織設定
  - アカウント設定
  - 通知設定

- **ログアウト**
  - ログアウト機能の実行
  - 確認ダイアログなしで即座に実行
  - サイドバーフッターに配置

#### 4. 将来機能のプレースホルダー

以下の機能は実装せず、グレーアウト状態で表示する：

- **センサー管理**
  - 「準備中」バッジ表示
  - クリック時に「準備中」メッセージ表示

- **リアルタイムデータ**
  - 「準備中」バッジ表示
  - クリック時に「準備中」メッセージ表示

- **履歴データ**
  - 「準備中」バッジ表示
  - クリック時に「準備中」メッセージ表示

### UI/UX要件

- **レスポンシブデザイン**
  - デスクトップ、タブレット、モバイルでの適切な表示
  - アイコンのみ表示時のツールチップ対応
- shadcn/ui のコンポーネントを使用して、統一感のあるデザインを実現

### 技術要件

#### 1. データ構造

```typescript
// サイドバーアイテムの構造（変更なし）
interface SidebarItem {
  id: string;
  label: string;
  icon: React.ComponentType<{ className?: string }>;
  href?: string;
  onClick?: () => void;
  disabled?: boolean;
  badge?: string;
  children?: SidebarItem[];
}

interface SidebarSection {
  id: string;
  title?: string;
  items: SidebarItem[];
}

// 組織データの構造 🆕
interface Organization {
  id: string;
  name: string;
  description: string | null;
  role: string; // "admin" | "member"
  joinedAt: Date;
  updatedAt: Date;
}

// サイドバーデータのAPI応答構造 🆕
interface SidebarData {
  user: {
    id: string;
    name: string;
  };
  organizations: Organization[];
  defaultOrganization: Organization | null;
}
```

#### 2. 状態管理

- **サイドバー開閉状態**
  - ローカルストレージに保存
  - デバイス種別ごとに記憶

- **アクティブメニュー**
  - 現在のパスから自動判定
  - Next.js の `usePathname` を使用

- **組織管理** 🆕
  - React Context による グローバル状態管理
  - ローカルストレージでの組織ID永続化
  - 定数ファイルでのストレージキー管理
  - デフォルト組織の自動設定（最新更新順）

#### 3. データ取得・API統合 🆕

- **tRPC + TanStack Query統合**
  - `trpc.user.sidebarData.queryOptions()` による自動データ取得
  - リアルタイムキャッシュ管理
  - ローディング状態の自動ハンドリング
  - エラーハンドリングの統合

- **バックエンドエンドポイント**
  - `getUserSidebarData`: ユーザー情報、所属組織一覧、デフォルト組織を取得
  - `getUserOrganizationDetails`: 特定組織における詳細情報を取得
  - user ルーターに `sidebarData` エンドポイントとして公開

- **データ初期化フロー**
  1. サイドバーデータをtRPCで取得
  2. 初期化完了後にデフォルト組織を設定
  3. 現在組織が未設定の場合のみデフォルト適用
  4. ローカルストレージで状態永続化

#### 4. UI コンポーネント構成 🆕

- **SidebarHeader**
  - 組織セレクター
  - BuildingIcon と組織名の表示
  - Select コンポーネントによるドロップダウン

- **SidebarContent**
  - メインナビゲーション
  - データ管理セクション
  - 設定セクション
  - グループ化とラベル表示

- **SidebarFooter**
  - ユーザー情報（UserIcon、ユーザー名）
  - ログアウトボタン

- **レスポンシブ対応**
  - `collapsible="icon"` による折りたたみ機能
  - アイコンのみ表示時の tooltip 対応

#### 4. アクセシビリティ

- **キーボードナビゲーション**
  - Tab キーでの順次移動
  - Enter/Space キーでの選択

- **スクリーンリーダー対応**
  - 適切な ARIA ラベル
  - セマンティックな HTML 構造

- **カラーコントラスト**
  - WCAG 2.1 AA レベル準拠
  - テキストコントラスト比 4.5:1 以上

#### 5. パフォーマンス

- **遅延読み込み**
  - アイコンの動的インポート（lucide-react）
  - 条件付きレンダリングによる最適化
  - ローディング状態でのスピナー表示

- **メモ化**
  - React.memo でのコンポーネント最適化
  - useMemo での計算結果キャッシュ
  - useQuery による自動キャッシュ管理

- **ローディング最適化**
  - 初期化未完了時のローディング表示
  - tRPC データ取得中のスピナー表示
  - 段階的なコンテンツ表示

### 実装優先度

#### Priority 1 (必須) ✅

- メインナビゲーション（ホーム、農業日誌）
- ユーザー情報表示
- 組織セレクター機能
- ログアウト機能
- 基本的なレスポンシブ対応

#### Priority 2 (推奨) ✅

- 設定メニュー（組織設定、アカウント設定）
- 折りたたみ機能
- アクティブ状態表示
- tRPC + TanStack Query 統合

#### Priority 3 (任意) ✅

- 将来機能のプレースホルダー
- アニメーション効果（shadcn/ui による）
- ローディング状態管理

### テスト要件

#### 1. 単体テスト

- **コンポーネントレンダリング**
  - メニュー項目の正常表示
  - 組織セレクターの表示
  - ローディング状態の表示
  - エラー状態のハンドリング

- **状態管理テスト**
  - 組織コンテキストの動作
  - ローカルストレージの読み書き
  - デフォルト組織の設定ロジック

- **アクティブ状態判定**
  - パス一致によるアクティブ表示
  - ダッシュボードの特別処理
  - 子メニューのアクティブ状態

#### 2. 統合テスト

- **データ取得フロー**
  - tRPC エンドポイントの動作確認
  - TanStack Query キャッシュの動作
  - 組織データの取得と表示

- **ナビゲーション機能**
  - ページ遷移の確認
  - 組織切り替え時の状態保持
  - ログアウト機能の動作

- **レスポンシブ動作**
  - 折りたたみ機能の動作
  - アイコンモードでの表示
  - タッチデバイスでの操作

#### 3. E2E テスト

- **ユーザーフロー**
  - ログイン → 組織選択 → メニュー操作
  - 組織切り替えシナリオ
  - 設定ページへの遷移

- **クロスデバイステスト**
  - デスクトップでの全機能確認
  - タブレット・モバイルでの表示確認
  - 異なる画面サイズでの動作
