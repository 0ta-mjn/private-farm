# ADR‑001 – tRPC vs Hono

**日付:** 2025‑07‑01 | **ステータス:** Accepted

---

## Context

従来型 Node ランタイムと Cloudflare Workers や Vercel Edge などのエッジランタイムの両方で動作する HTTP API レイヤが必要。
候補として tRPC と Hono を比較。

### tRPC

**Pros**

- クライアントとサーバー間での E2E 型安全性
- React/Next との密結合統合（React Query フック、SSR ヘルパ、バッチ処理）
- フルスタック TypeScript モノリス向けに優れた DX

**Cons**

- Node を前提としており、エッジランタイムではポリフィル／アダプタが必要
- エコシステムが小さく、クラシックな HTTP フレームワークほどミドルウェアや事例が少ない
- ネットワーク境界を意識しにくく、新規参入者が驚く場合がある

### Hono

**Pros**

- Express ライクで最小構成、Express/Fastify 経験者は学習コストが低い
- Node, Deno, Bun, Cloudflare, Vercel Edge など複数ランタイムを追加ツール無しでサポート
- ミドルウェアパターンにより高度な合成が可能（ストリーム、ヘッダ操作、早期リターン等）
- コミュニティとプラグイン（zod validation, OpenAPI generator）が急成長中

**Cons**

- E2E 型推論は自動ではなく、型共有は外部スキーマ (zod, OpenAPI) に依存
- クライアント SDK 生成にビルドステップが必要で、tRPC 比でボイラープレートが増える
- React/Next 連携は存在するが、tRPC の組み込みユーティリティほどシームレスではない

---

## Decision

**Hono** を主要な HTTP API フレームワークとして採用する。

### 理由

1. **ランタイムの柔軟性** – 同一ハンドラを Cloud Run と Cloudflare Workers の双方でコード変更なく動かせる。
2. **段階的導入** – まずは薄いルータとして開始し、後でバリデーション・認可・ドキュメントを追加できる。特定抽象へのロックインがない。
3. **馴染みやすいメンタルモデル** – Express/Fastify 出身の開発者が初日から生産的に書けるため、オンボーディング摩擦が低い。
4. **健全なエコシステムの成長** – プラグイン／ライブラリの増加とベンチマーク結果から、停滞リスクが低いと判断。

---

## Consequence

- **クライアント SDK 生成** – `hono/zod-openapi` で OpenAPI スキーマを生成し、`openapi-typescript` で型付きクライアントを生成する。tRPC の自動フックを置き換える形となる。
- **バリデーション規律** – すべてのルートで zod スキーマを宣言必須とし、CI で未バリデーションのエンドポイントを拒否することで型安全性を維持する。
- **パフォーマンス** – Worker バンドルサイズが約 50 KB 減少し、コールドスタート遅延が約 5 ms 改善（2025 年 7 月時点の社内ベンチマーク）。
- **チームスキル** – tRPC 特有の抽象ではなくポータブルな HTTP スキルを習得できる一方、スキーマファースト思考への投資が必要。
- **可逆性** – ビジネスロジックはサービス層に隔離しており、トランスポート層に依存しないため、tRPC に戻す場合はルートハンドラとクライアント生成を主に置き換えるだけで済む。
